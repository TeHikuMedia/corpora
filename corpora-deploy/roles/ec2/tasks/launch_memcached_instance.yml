
- name: Create Memcached security group
  local_action:
    module: ec2_group
    name: "{{ project_name }}-{{env_type}}-memcached"
    description: "Security group for {{ project_name }} {{env_type}} memcached server"
    region: ap-southeast-2
    rules:
      - proto: tcp
        from_port: 11211
        to_port: 11211
        group_name: "{{ project_name }}-{{env_type}}-webserver"
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: 0.0.0.0/0
    rules_egress:
      - proto: all
        from_port: -1
        to_port: -1
        cidr_ip: 0.0.0.0/0
  register: ec2_group
  tags:
    sg_config

- name: Launch memcached instance
  local_action:
    module: ec2
    region: ap-southeast-2
    keypair: "{{ ec2_key_pair }}"
    group: "{{ project_name }}-{{ env_type }}-memcached"
    instance_type: "{{ memcached_instance_type }}"
    image: ami-b740db8d # Debian GNU/Linux - 7.5, released 05/09/2014 - ap-southeast-2 (Sydney)
    wait: yes
    instance_tags:
      memcached: "{{env_type}}"
    exact_count: 1
    count_tag: 
      memcached: "{{env_type}}"
  register: ec2_memcached

# Tasks for tagging and grouping launched instances
- name: Tag instance
  local_action: ec2_tag resource={{ item.id }} region=ap-southeast-2 state=present
  with_items: ec2_memcached.tagged_instances
  args:
    tags:
      Name: "{{project_name}}-{{env_type}}-memcached"
      env: "{{env_type}}"


